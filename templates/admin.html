<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Äî Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <main class="card">
    <div class="admin-top">
      <div>
        <h1>Admin</h1>
        <p class="sub">Resumo, √∫ltimos registos e gr√°ficos</p>
      </div>

      <div class="admin-actions">
        <a class="action-btn" href="/api/export.csv">‚¨áÔ∏è Exportar CSV (Excel)</a>
        <a class="action-btn" href="/api/export.json">‚¨áÔ∏è Exportar JSON</a>
        <a class="action-btn" href="/">‚Ü©Ô∏è Voltar ao site</a>
      </div>
    </div>

    <!-- KPIs -->
    <section class="admin-grid">
      <div class="admin-box">
        <h2>Hoje ({{ today }})</h2>
        <p class="admin-kpi">
          <span class="kpi-label">Total de registos:</span>
          <span class="kpi-value">{{ total_today }}</span>
        </p>
      </div>

      <div class="admin-box">
        <h2>Por atividade (hoje)</h2>

        {% if per_activity|length == 0 %}
          <p class="admin-muted">Ainda n√£o h√° registos hoje.</p>
        {% else %}
          <ul class="admin-list">
            {% for item in per_activity %}
              <li>
                <span class="tag">{{ item.activity }}</span>
                <span class="count">{{ item.total }}</span>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </section>

    <!-- GR√ÅFICOS -->
    <section class="admin-grid">
      <div class="admin-box">
        <h2>Gr√°fico ‚Äî Hoje por atividade</h2>
        <div class="chart-wrap">
          <canvas id="chartToday"></canvas>
        </div>
      </div>

      <div class="admin-box">
        <h2>Gr√°fico ‚Äî √öltimos 7 dias</h2>
        <div class="chart-wrap">
          <canvas id="chart7days"></canvas>
        </div>
      </div>
    </section>

    <!-- TABELA COM PAGINA√á√ÉO -->
    <section class="admin-box admin-table-box">
      <h2>Registos</h2>

      {% if recent|length == 0 %}
        <p class="admin-muted">Ainda n√£o h√° registos.</p>
      {% else %}
        <div class="table-wrap">
          <table class="admin-table" id="regTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Atividade</th>
                <th>Clique n¬∫</th>
                <th>Data</th>
                <th>Hora</th>
              </tr>
            </thead>
            <tbody>
              {% for r in recent %}
              <tr>
                <td>{{ r.id }}</td>
                <td>{{ r.activity }}</td>
                <td>{{ r.seq }}</td>
                <td>{{ r.date }}</td>
                <td>{{ r.time }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- CONTROLOS -->
        <div class="admin-actions" style="margin-top:12px; justify-content:center">
          <button class="action-btn" onclick="prevPage()">‚¨ÖÔ∏è Anterior</button>
          <span class="admin-muted" id="pageInfo"></span>
          <button class="action-btn" onclick="nextPage()">Seguinte ‚û°Ô∏è</button>
        </div>
      {% endif %}
    </section>

  </main>

  <script>
    /* =======================
       PAGINA√á√ÉO FRONT-END
       ======================= */
    const rowsPerPage = 10;   // üëà X registos por p√°gina
    const table = document.getElementById("regTable");
    const rows = table ? Array.from(table.querySelectorAll("tbody tr")) : [];
    let currentPage = 1;

    function renderTable(){
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;

      rows.forEach((row, i) => {
        row.style.display = (i >= start && i < end) ? "" : "none";
      });

      const totalPages = Math.max(1, Math.ceil(rows.length / rowsPerPage));
      document.getElementById("pageInfo").textContent =
        `P√°gina ${currentPage} de ${totalPages}`;
    }

    function nextPage(){
      const totalPages = Math.ceil(rows.length / rowsPerPage);
      if (currentPage < totalPages){
        currentPage++;
        renderTable();
      }
    }

    function prevPage(){
      if (currentPage > 1){
        currentPage--;
        renderTable();
      }
    }

    if (rows.length) renderTable();

    /* =======================
       GR√ÅFICOS
       ======================= */
    async function loadTodayChart() {
      const res = await fetch("/api/stats/today");
      const data = await res.json();

      new Chart(document.getElementById("chartToday"), {
        type: "bar",
        data: {
          labels: data.labels,
          datasets: [{
            label: "Registos hoje",
            data: data.values
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    async function load7DaysChart() {
      const res = await fetch("/api/stats/last7days");
      const data = await res.json();

      new Chart(document.getElementById("chart7days"), {
        type: "line",
        data: {
          labels: data.labels,
          datasets: [{
            label: "Total por dia",
            data: data.values,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    loadTodayChart();
    load7DaysChart();
  </script>

</body>
</html>
